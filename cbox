#!/bin/bash
set -e

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
COMPOSE_FILE="$SCRIPT_DIR/compose.yaml"

usage() {
    cat <<EOF
Usage: cbox <command> [options]

Run Claude Code in a sandboxed Docker container.

Commands:
    run         Run claude in the container (default if no command given)
    build       Build the container image for the current user
    kill        List and optionally kill running codebox containers
    help        Show this help message

Examples:
    cbox                    Run claude in current git repository
    cbox run                Same as above
    cbox build              Build the image for your user
    cbox build --no-cache   Rebuild from scratch
    cbox kill               Interactively kill running containers
    cbox kill --all         Kill all running containers without prompting

Environment:
    ANTHROPIC_API_KEY       API key for Claude (required for run)
EOF
}

# Create env file with current user info
create_env_file() {
    local env_file="$1"
    local repo_root="${2:-/tmp}"
    local work_dir="${3:-/tmp}"

    cat > "$env_file" <<EOF
HOST_UID=$(id -u)
HOST_GID=$(id -g)
HOST_USER=$USER
HOST_HOME=$HOME
TERM=$TERM
ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
REPO_ROOT=$repo_root
WORK_DIR=$work_dir
EOF
}

cmd_build() {
    local env_file
    env_file="$(mktemp /tmp/codebox.XXXXXX.env)"
    trap 'rm -f "$env_file"' EXIT

    create_env_file "$env_file"
    exec docker compose -f "$COMPOSE_FILE" --env-file "$env_file" build "$@"
}

cmd_run() {
    local repo_root work_dir env_file extra_args=()

    repo_root="$(git rev-parse --show-toplevel 2>/dev/null)" || {
        echo "Error: must be run from within a git repository" >&2
        exit 1
    }
    work_dir="$(pwd)"

    # Conditionally mount Emacs server socket if it exists
    local emacs_socket_dir="/run/user/$(id -u)/emacs"
    if [[ -S "$emacs_socket_dir/server" ]]; then
        extra_args+=(-v "$emacs_socket_dir:$emacs_socket_dir")
    fi

    env_file="$(mktemp /tmp/codebox.XXXXXX.env)"
    trap 'rm -f "$env_file"' EXIT

    create_env_file "$env_file" "$repo_root" "$work_dir"
    exec docker compose -f "$COMPOSE_FILE" --env-file "$env_file" run --rm "${extra_args[@]}" cbox "$@"
}

cmd_kill() {
    local image_name="codebox:$USER"
    local containers kill_all=false

    if [[ "${1:-}" == "--all" ]]; then
        kill_all=true
    fi

    containers=$(docker ps --filter "ancestor=$image_name" --format '{{.ID}}\t{{.Names}}\t{{.Status}}\t{{.RunningFor}}')

    if [[ -z "$containers" ]]; then
        echo "No running codebox containers found."
        exit 0
    fi

    echo "Running codebox containers:"
    echo
    printf "%-12s %-30s %-20s %s\n" "CONTAINER" "NAME" "STATUS" "RUNNING FOR"
    echo "--------------------------------------------------------------------------------"
    echo "$containers" | while IFS=$'\t' read -r id name status running_for; do
        printf "%-12s %-30s %-20s %s\n" "$id" "$name" "$status" "$running_for"
    done
    echo

    if $kill_all; then
        echo "$containers" | while IFS=$'\t' read -r id name status running_for; do
            echo "Killing $id ($name)..."
            docker kill "$id" > /dev/null
        done
        echo "All containers killed."
    else
        echo "$containers" | while IFS=$'\t' read -r id name status running_for; do
            read -r -p "Kill $id ($name)? [y/N] " response < /dev/tty
            if [[ "$response" =~ ^[Yy]$ ]]; then
                docker kill "$id" > /dev/null
                echo "  Killed."
            else
                echo "  Skipped."
            fi
        done
    fi
}

# Parse command
case "${1:-run}" in
    run)
        shift 2>/dev/null || true
        cmd_run "$@"
        ;;
    build)
        shift
        cmd_build "$@"
        ;;
    kill)
        shift
        cmd_kill "$@"
        ;;
    help|--help|-h)
        usage
        exit 0
        ;;
    *)
        echo "Error: unknown command '$1'" >&2
        echo >&2
        usage >&2
        exit 1
        ;;
esac
