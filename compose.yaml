services:
  cbox:
    build:
      context: .
      args:
        HOST_UID: ${HOST_UID}
        HOST_GID: ${HOST_GID}
        HOST_USER: ${HOST_USER}
        HOST_HOME: ${HOST_HOME}
    image: codebox:${HOST_USER}
    stdin_open: true
    tty: true
    init: true  # Required for proper Ctrl-C signal handling
    environment:
      - HOST_HOME
      - TERM
      - ANTHROPIC_API_KEY
      - EDITOR
      - ALTERNATE_EDITOR
      - XDG_RUNTIME_DIR=/run/user/${HOST_UID}
      # Prevent git/ssh from prompting for credentials, which would hijack stdin:
      #   GIT_TERMINAL_PROMPT - disables git's built-in terminal prompts
      #   GIT_ASKPASS - disables external credential helper programs
      #   GIT_SSH_COMMAND - forces ssh to run in batch mode (no prompts)
      - GIT_TERMINAL_PROMPT=0
      - GIT_ASKPASS=
      - GIT_SSH_COMMAND=ssh -o BatchMode=yes
    volumes:
      - ${HOST_HOME}/.claude:${HOST_HOME}/.claude
      - ${HOST_HOME}/.claude.json:${HOST_HOME}/.claude.json
      - ${HOST_HOME}/.gitconfig:${HOST_HOME}/.gitconfig:ro
      - ${HOST_HOME}/.local/bin:${HOST_HOME}/.local/bin:ro
      - ${HOST_HOME}/.local/share/claude:${HOST_HOME}/.local/share/claude:ro
      - ${REPO_ROOT}:${REPO_ROOT}
    working_dir: ${WORK_DIR}
